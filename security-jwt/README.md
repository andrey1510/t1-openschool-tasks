__README__
==========

Данное приложение предназначено для для аутентификации и авторизации пользователей.
Использованный стек: Java SE 17, Spring Boot 3.3.1, Spring Security, JJWT, JPA, Maven, Lombok, REST-архитектура, 
Swagger, PostgreSQL.

Установка и запуск:
-----------------------------------

Нужно склонировать репозиторий. Затем запустить сервис **security-jwt** и его базу PostgreSQL, согласно инструкциям ниже.

**База данных:**

Нужно создать базу PostgreSQL :
1. В директории ```t1-openschool-tasks\security-jwt``` запустить файл **docker-compose.yml**. Его следует запускать 
с помощью IDE, или выполнив команды ```docker-compose build``` и ```docker-compose up -d``` в директории, где он находится.
В результате будет создан и запущен контейнер с базой.
2. или создать на Вашем сервере PostgreSQL соответствующую базу PostgreSQL с параметрами:
   хост, порт и база: ```localhost:8225/userbase```;
   имя пользователя: ```user```;
   пароль: ```password```.

**Сервис security-jwt:**

После этого запустить исходный код приложения **security-jwt** в IDE.

Работа с приложением:
---------------------------------------

После запуска приложение будет доступно по адресу: 

```http://localhost:8224```

Приложение поддерживает Swagger. Получить доступ к Swagger UI можно по адресу:

```http://localhost:8224/swagger-ui.html```

Документация содержится в Swagger.

Функционал приложения:
------------------------------------------

Сервис **security-jwt** имеет следующий функционал:
1. регистрация пользователя в сервисе с настройкой аутентификации (имя пользователя и пароль) и авторизации (роли); 
2. сохранение регистрационных данных пользователя в базе PostgreSQL
3. аутентификация пользователя в сервисе по логину и паролю, с генерацией JWT и refresh токенов; 
4. доступ пользователя к защищенным эндпойнтам по JWT токену, авторизация доступа по ролям;
5. обновление JWT токена с помощью refresh токена.

Работа с приложением
------------------------------------------

### Контроллер UserController 

Он содержит все методы, которые осуществляют регистрацию и аутентификацию пользователей. 
Доступ к этим методам не требует аутентификации через JWT.

**Метод createUser** - принимает запросы POST на:

```http://localhost:8224/api/users/register```

Этот метод осуществляет регистрацию новых пользователей. 

Метод содержит два обязательных параметра - имя пользователя и пароль, 
а также 2 опциональных - присвоение ролей Customer и Provider. Роль User присваивается всегда автоматически.

Метод возвращает код ```200``` и сообщение об успешном выполнении операции.

В случае, если в базе уже имеется пользователь с указанным в запросе именем, 
об этом будет выдано сообщение с кодом ```400```.

**Метод login** - принимает запросы POST на:

```http://localhost:8224/api/users/login```

Этот метод предназначен для авторизации зарегистрированного пользователя в приложении.

Метод содержит два обязательных параметра - имя пользователя и пароль. Необходимо указывать данные 
уже зарегистрированных пользователей. 

Метод возвращает JSON с JWT-токеном и Refresh-токеном и код ```200```.

В случае, если в базе нет пользователя с введенным именем или если пароль введен неверно, об этом будет выдано 
соответствующее сообщение (код ```403``` или ```404``` ).

**Метод refreshToken** - принимает запросы POST на:

```http://localhost:8224/api/users/refresh-token```

Этот метод предназначен для обновления истекшего JWT-токена.

Метод содержит один обязательный параметр - Refresh-код. Refresh-код нужно взять из JSON, 
полученного от метода **login**, или из JSON, полученного от данного метода (если токен обновлялся не один раз).

Метод возвращает JSON с JWT-токеном и Refresh-токеном, и код ```200```.

Срок действия Refresh-токена ограничен, его можно настроить в файле application.yml 
в параметре ```jwt.expiration.refresh``` (в миллисекундах). 
Сейчас это 5 минут.

В случае, если Refresh-код неверный, об этом будет выдано сообщение с кодом ```403```.


### Контроллер SampleController

Он содержит методы с примерами операций с авторизацией пользователей. Доступ к этим методам всегда требует 
аутентификацию через JWT. 
Во все запросы к методам из этого контроллера нужно добавлять взятый из методов **login** или **refreshToken** JWT-токен.
При отправке запроса через Swagger, JWT-токен нужно ввести в окне (открывается кнопкой Authorize) и нажать Authorize. 
Тогда Swagger будет добавлять введенный токен в запросы к защищенным методам. 
Чтобы прекратить этого, нужно нажать на кнопку Logout в этом же окне.

Срок действия JWT-токена ограничен, его можно настроить в файле application.yml
в параметре ```jwt.expiration.token``` (в миллисекундах).
Сейчас это 1 минута.

**Метод checkPerformerAccess** - принимает запросы GET на:

```http://localhost:8224/api/products/shop/performer-board/check-access```

Доступ к этому методу разрешен только зарегистрированным пользователям с ролью Performer. В противном случае в доступе 
будет отказано с кодом ```403```.

**Метод checkCustomerAccess** - принимает запросы GET на:

```http://localhost:8224/api/products/shop/customer-board/check-access```

Доступ к этому методу разрешен только зарегистрированным пользователям с ролью Customer. В противном случае в доступе
будет отказано с кодом ```403```.

**Метод checkPerformerOrCustomerAccess** - принимает запросы GET на:

```http://localhost:8224/shop/statistics/check-performer-and-customer-access```

Доступ к этому методу разрешен только зарегистрированным пользователям с ролью Customer или Performer (подойдет любая). 
В противном случае в доступе будет отказано с кодом ```403```.

**Метод checkUserAccess** - принимает запросы GET на:

```http://localhost:8224/api/products/shop/demo/check-user-access```

Доступ к этому методу разрешен всем зарегистрированным пользователям.

### Unit-тесты

К сервису прилагаются Unit-тесты.